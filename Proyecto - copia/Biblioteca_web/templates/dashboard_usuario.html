<!-- ========================================= -->
<!--  DASHBOARD_USUARIO.HTML - Panel Usuario  -->
<!--  Muestra perfil, multas y préstamos      -->
<!--  activos del usuario final.             -->
<!-- ========================================= -->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Estilos específicos para el dashboard de usuario -->
    <link rel="stylesheet" href="{{ url_for('static', filename='estilos_dashboard_usuario.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='toast_styles.css') }}">
    <title>Mi Biblioteca - Panel de Usuario</title>
</head>
<body>
    <!-- ========== MENSAJES FLASH ========== -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="alerts">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- ========== ENCABEZADO Y USUARIO ========== -->
    <div class="header">
        <div class="logo">
            <img src="{{ url_for('static', filename='imagenes/LogoInicial.jpg') }}" alt="Logo" class="logo-img">
            <h1>Mi Biblioteca</h1>
        </div>
        <div class="user-info">
            <span>Bienvenido, {{ usuario.nombre }} {{ usuario.apellido }}</span>
            <a href="{{ url_for('logout') }}" class="btn-logout">Cerrar Sesión</a>
        </div>
    </div>

    <div class="container">
        <!-- ========== PANEL DE PERFIL ========== -->
        <div class="user-panel">
            <h2>Mi Perfil</h2>
            <form method="POST" action="{{ url_for('editar_perfil_usuario') }}" id="form-perfil">
                <div class="profile-info">
                    <!-- Campos que NO se editan -->
                    <div class="info-item">
                        <label>Nombre:</label>
                        <span>{{ usuario.nombre }} {{ usuario.apellido }}</span>
                    </div>
                    <div class="info-item">
                        <label>Documento:</label>
                        <span>{{ usuario.documento }}</span>
                    </div>
                    
                    <!-- Campos que SÍ se editan -->
                    <div class="info-item">
                        <label>Email:</label>
                        <span id="email-display" class="campo-editable">{{ usuario.email }}</span>
                        <input type="email" id="email-input" name="email" value="{{ usuario.email }}" 
                               class="campo-input" style="display: none;" required>
                    </div>
                    <div class="info-item">
                        <label>Teléfono:</label>
                        <span id="telefono-display" class="campo-editable">{{ usuario.telefono }}</span>
                        <input type="tel" id="telefono-input" name="telefono" value="{{ usuario.telefono }}" 
                               class="campo-input" style="display: none;" required>
                    </div>
                </div>
                
                <!-- Botones que cambian según el modo -->
                <div class="profile-actions">
                    <button type="button" id="btn-editar" class="btn-edit-profile" onclick="activarEdicion()">
                        Editar Perfil
                    </button>
                    <div id="botones-guardar" style="display: none;">
                        <button type="submit" class="btn-save">Guardar Cambios</button>
                        <button type="button" class="btn-cancel" onclick="cancelarEdicion()"> Cancelar</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- ========== PANEL DE MULTAS ========== -->
        <div class="multas-panel">
            <h2>Mis Multas</h2>
            {% if total_multas %}
                <form action="{{ url_for('pagar_multas') }}" method="POST">
                    <ul>
                        {% for prestamo in multas %}
                            <li>
                                <input type="checkbox" name="ids_prestamos" value="{{ prestamo.id }}">
                                Libro: {{ prestamo.titulo_libro }} - Multa: ${{ "%.2f"|format(prestamo.multa) }}
                            </li>
                        {% endfor %}
                    </ul>
                    <button type="submit" class="btn-pagar-multas">Pagar Multas</button>
                    <button type="button" onclick="seleccionarTodos()">Seleccionar Todos</button>
                </form>
            {% else %}
                <p>No tienes multas pendientes.</p>
            {% endif %}
        </div>
        <script>
        function seleccionarTodos() {
            document.querySelectorAll('input[name="ids_prestamos"]').forEach(cb => cb.checked = true);
        }
        </script>

        <!-- ========== PANEL DE PRÉSTAMOS ACTIVOS ========== -->
        <div class="loans-panel">
            <h2>Mis Préstamos Activos</h2>
            {% if prestamos %}
                <div class="loans-list">
                    {% for prestamo in prestamos %}
                        {% if not prestamo.fecha_devolucion_real %}
                        <div class="loan-item">
                            <div class="book-info">
                                <h3>{{ prestamo.titulo_libro }}</h3>
                                <p><strong>Autor:</strong> {{ prestamo.autor_libro }}</p>
                                <p><strong>Género:</strong> {{ prestamo.genero_libro }}</p>
                                <p><strong>Editorial:</strong> {{ prestamo.editorial_libro }}</p>
                                <div class="loan-dates">
                                    <p><strong>Fecha de préstamo:</strong> {{ prestamo.fecha_prestamo }}</p>
                                    <p><strong>Fecha de devolución:</strong> {{ prestamo.fecha_devolucion_esperada }}</p>
                                </div>
                            </div>
                            <div class="loan-actions">
                                {% if prestamo.multa > 0 %}
                                    <span class="multa">Multa: ${{ "%.2f"|format(prestamo.multa) }}</span>
                                {% endif %}
                                <button class="btn-return" data-prestamo-id="{{ prestamo.id }}" onclick="devolverLibroNuevo(this)">Devolver</button>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% else %}
                <p class="no-loans">No tienes préstamos activos</p>
            {% endif %}
        </div>
        <!-- Modal de libro: overlay y contenido como hermanos -->
        <div id="modalLibro" class="modal" style="display:none;">
            <div class="modal-overlay"></div>
            <div class="modal-content" id="modalLibroContent" tabindex="-1" role="dialog" aria-modal="true">
                <!-- Aquí se cargará la info del libro y el formulario de préstamo/devolución -->
            </div>
        </div>
        <!-- Panel de libros disponibles -->
        <div class="books-panel">
            <h2>Libros Disponibles</h2>
            <div class="search-books">
                <input type="text" id="searchBooks" placeholder="Buscar libros por título, autor o género...">
                <button class="btn-buscar" onclick="buscarLibros()">Buscar</button>
            </div>
            <div id="booksResults" class="books-results">
                <!-- Aquí se cargarán los libros via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal de confirmación para devolver libros -->
    <div id="modalConfirmacion" class="modal-overlay-confirmacion">
        <div class="modal-contenido-confirmacion">
            <div class="modal-header-confirmacion">
                <h3><i class="fa fa-exclamation-triangle"></i> Confirmar Devolución</h3>
                <button type="button" class="btn-cerrar-modal" onclick="cerrarModalConfirmacion()">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="modal-body-confirmacion">
                <div class="info-libro-devolucion">
                    <div class="icono-libro">
                        <i class="fa fa-book"></i>
                    </div>
                    <div class="detalles-libro">
                        <h4 id="tituloLibroDevolucion">Título del Libro</h4>
                        <p><strong>Autor:</strong> <span id="autorLibroDevolucion">Autor</span></p>
                        <p><strong>Fecha de préstamo:</strong> <span id="fechaPrestamoDevolucion">DD/MM/AAAA</span></p>
                        <p><strong>Fecha límite:</strong> <span id="fechaLimiteDevolucion">DD/MM/AAAA</span></p>
                    </div>
                </div>
                <div class="mensaje-confirmacion">
                    <p>¿Estás seguro de que deseas devolver este libro?</p>
                    <p class="nota-devolucion">Esta acción no se puede deshacer.</p>
                </div>
            </div>
            <div class="modal-footer-confirmacion">
                <button type="button" class="btn btn-cancelar" onclick="cerrarModalConfirmacion()">
                    <i class="fa fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-confirmar" onclick="confirmarDevolucion()">
                    <i class="fa fa-check"></i> Confirmar Devolución
                </button>
            </div>
        </div>
    </div>

    <script>
    // FUNCIÓN PRESTAR LIBRO - VERSIÓN LIMPIA Y DIRECTA
    window.prestarLibro = function(idLibro) {
        console.log('=== INICIANDO PRÉSTAMO ===');
        console.log('ID del libro:', idLibro);
        
        // Crear formulario dinámico
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/prestamos/prestar';
        form.style.display = 'none';
        
        // Añadir campos
        const campos = [
            {name: 'documento_usuario', value: 'AUTO'},
            {name: 'id_libro', value: idLibro},
            {name: 'dias', value: '7'}
        ];
        
        campos.forEach(campo => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = campo.name;
            input.value = campo.value;
            form.appendChild(input);
            console.log(`Campo añadido: ${campo.name} = ${campo.value}`);
        });
        
        document.body.appendChild(form);
        console.log('Enviando formulario...');
        form.submit();
    };
    
    console.log('prestarLibro function defined globally');
    </script>
    <script src="{{ url_for('static', filename='script_dashboard_usuarios.js') }}?v=20251001-2135-FINAL"></script>
    <script src="{{ url_for('static', filename='toast_notifications.js') }}"></script>
</body>
</html>